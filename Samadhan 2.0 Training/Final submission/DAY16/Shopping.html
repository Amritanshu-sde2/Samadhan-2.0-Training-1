<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 16: E-Commerce Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="flex items-center justify-between p-4 bg-white rounded-2xl shadow-lg sticky top-4 z-50">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">My Store</h1>
            <div class="flex items-center space-x-4">
                <p id="user-id-display" class="text-sm text-gray-500 truncate" onclick="copyToClipboard()">
                    User ID: Loading...
                </p>
                <button id="cart-btn" class="relative p-2 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.105 1.764.757 1.764H18a2 2 0 002-2v-4a2 2 0 00-2-2h-1.559a2 2 0 01-1.802-1.127l-.317-.969a2 2 0 00-1.802-1.127H9.257a2 2 0 00-1.802 1.127L7 13z" />
                    </svg>
                    <span id="cart-item-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full">0</span>
                </button>
            </div>
        </header>

        <!-- Product Catalog -->
        <main id="product-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mt-8">
            <div id="loading-spinner" class="col-span-full flex justify-center items-center h-64">
                <svg class="animate-spin h-10 w-10 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </main>

        <!-- Cart Panel (initially hidden) -->
        <div id="cart-panel" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden">
            <div class="absolute right-0 top-0 h-full w-full sm:w-2/3 md:w-1/2 lg:w-1/3 bg-white p-6 shadow-xl transform transition-transform duration-300 translate-x-full">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Your Shopping Cart</h2>
                    <button id="close-cart-btn" class="text-gray-500 hover:text-gray-800 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="cart-items" class="h-3/4 overflow-y-auto mb-4">
                    <p id="empty-cart-message" class="text-center text-gray-500 mt-12 hidden">Your cart is empty.</p>
                </div>
                <div class="mt-4 border-t pt-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-bold text-gray-900">Total:</span>
                        <span id="cart-total" class="text-xl font-bold text-gray-900">$0.00</span>
                    </div>
                    <button id="checkout-btn" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">
                        Checkout
                    </button>
                </div>
            </div>
        </div>

        <!-- Custom Modal for Alerts/Messages -->
        <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300">
                <div class="flex justify-end">
                    <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="modal-content" class="text-center">
                    <h3 id="modal-title" class="text-xl font-semibold mb-2"></h3>
                    <p id="modal-message" class="text-gray-600 mb-4"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI Elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const productContainer = document.getElementById('product-container');
        const cartBtn = document.getElementById('cart-btn');
        const cartPanel = document.getElementById('cart-panel');
        const closeCartBtn = document.getElementById('close-cart-btn');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartItemCountSpan = document.getElementById('cart-item-count');
        const cartTotalSpan = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('checkout-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const closeModalBtn = document.getElementById('close-modal-btn');

        // State
        let db;
        let auth;
        let userId;
        let products = [];
        let cart = {};

        // Helper function to show a custom modal
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            customModal.classList.remove('hidden');
        }

        // Helper function to hide the custom modal
        function hideModal() {
            customModal.classList.add('hidden');
        }

        closeModalBtn.addEventListener('click', hideModal);
        customModal.addEventListener('click', (e) => {
            if (e.target === customModal) {
                hideModal();
            }
        });

        // Copy User ID to clipboard
        window.copyToClipboard = function() {
            const tempInput = document.createElement('input');
            tempInput.value = userId;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                showModal('Copied!', 'Your User ID has been copied to the clipboard.');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showModal('Error', 'Failed to copy User ID. Please copy it manually: ' + userId);
            }
            document.body.removeChild(tempInput);
        };

        // Initialize Firebase and set up listeners
        async function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                userIdDisplay.textContent = `User ID: ${userId}`;
                
                startRealtimeListeners();
                await initializeProducts();
            } catch (error) {
                console.error("Firebase Initialization Error: ", error);
                userIdDisplay.textContent = 'Error: Check console';
                showModal('Initialization Error', 'Failed to connect to the database. Check the console for details.');
            }
        }

        // Initialize products in Firestore if they don't exist
        async function initializeProducts() {
            const productsRef = collection(db, `artifacts/${appId}/public/data/products`);
            const productDocRef1 = doc(productsRef, 'product1');
            const productDocRef2 = doc(productsRef, 'product2');
            const productDocRef3 = doc(productsRef, 'product3');
            const productDocRef4 = doc(productsRef, 'product4');

            const productsData = [
                { id: 'product1', name: 'Elegant Watch', description: 'A timeless timepiece for every occasion.', price: 150.00, imageUrl: 'https://placehold.co/400x400/2c3e50/ecf0f1?text=Watch' },
                { id: 'product2', name: 'Premium Headphones', description: 'Immersive sound quality with noise cancellation.', price: 299.99, imageUrl: 'https://placehold.co/400x400/2980b9/ecf0f1?text=Headphones' },
                { id: 'product3', name: 'Smart Kettle', description: 'Boil water to the perfect temperature with a tap.', price: 89.50, imageUrl: 'https://placehold.co/400x400/34495e/ecf0f1?text=Kettle' },
                { id: 'product4', name: 'Leather Wallet', description: 'Minimalist design with maximum storage.', price: 45.00, imageUrl: 'https://placehold.co/400x400/16a085/ecf0f1?text=Wallet' }
            ];
            
            await setDoc(productDocRef1, productsData[0]);
            await setDoc(productDocRef2, productsData[1]);
            await setDoc(productDocRef3, productsData[2]);
            await setDoc(productDocRef4, productsData[3]);
        }

        // Set up real-time listeners for products and cart
        function startRealtimeListeners() {
            // Products Listener
            const productsRef = collection(db, `artifacts/${appId}/public/data/products`);
            onSnapshot(productsRef, (snapshot) => {
                loadingSpinner.classList.add('hidden');
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts();
            }, (error) => {
                console.error("Error fetching products: ", error);
                showModal('Error', 'Failed to fetch product data.');
            });

            // Cart Listener
            const userCartDocRef = doc(db, `artifacts/${appId}/users/${userId}/carts/cart`);
            onSnapshot(userCartDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    cart = docSnapshot.data().items || {};
                } else {
                    cart = {};
                }
                updateCartUI();
            }, (error) => {
                console.error("Error fetching cart: ", error);
                showModal('Error', 'Failed to fetch cart data.');
            });
        }

        // Render products on the page
        function renderProducts() {
            productContainer.innerHTML = '';
            if (products.length === 0) {
                productContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">No products found.</p>';
                return;
            }

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-white rounded-xl shadow-lg overflow-hidden flex flex-col transform hover:scale-105 transition-transform duration-300';
                
                productCard.innerHTML = `
                    <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-4 flex flex-col flex-grow">
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">${product.name}</h2>
                        <p class="text-gray-600 text-sm mb-4 flex-grow">${product.description}</p>
                        <div class="flex items-center justify-between mt-auto">
                            <span class="text-2xl font-bold text-gray-900">$${product.price.toFixed(2)}</span>
                            <button data-product-id="${product.id}" class="add-to-cart-btn px-4 py-2 bg-indigo-500 text-white font-medium rounded-full shadow-md hover:bg-indigo-600 transition-colors duration-200">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                `;
                productContainer.appendChild(productCard);
            });

            // Add event listeners for "Add to Cart" buttons
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.productId;
                    addToCart(productId);
                });
            });
        }

        // Add a product to the cart
        async function addToCart(productId) {
            const userCartDocRef = doc(db, `artifacts/${appId}/users/${userId}/carts/cart`);
            const product = products.find(p => p.id === productId);

            if (!product) {
                console.error("Product not found:", productId);
                return;
            }

            const newCart = { ...cart };
            if (newCart[productId]) {
                newCart[productId].quantity += 1;
            } else {
                newCart[productId] = { ...product, quantity: 1 };
            }

            try {
                await setDoc(userCartDocRef, { items: newCart });
                showModal('Success!', `${product.name} added to cart.`);
            } catch (error) {
                console.error("Error adding to cart: ", error);
                showModal('Error', 'Failed to add item to cart.');
            }
        }

        // Remove a product from the cart
        async function removeFromCart(productId) {
            const userCartDocRef = doc(db, `artifacts/${appId}/users/${userId}/carts/cart`);
            const newCart = { ...cart };
            if (newCart[productId]) {
                delete newCart[productId];
                try {
                    await setDoc(userCartDocRef, { items: newCart });
                } catch (error) {
                    console.error("Error removing from cart: ", error);
                    showModal('Error', 'Failed to remove item from cart.');
                }
            }
        }

        // Update the cart UI with current items
        function updateCartUI() {
            cartItemsContainer.innerHTML = '';
            const itemKeys = Object.keys(cart);
            let total = 0;
            let totalItems = 0;

            if (itemKeys.length === 0) {
                emptyCartMessage.classList.remove('hidden');
            } else {
                emptyCartMessage.classList.add('hidden');
                itemKeys.forEach(productId => {
                    const item = cart[productId];
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    totalItems += item.quantity;

                    const cartItemEl = document.createElement('div');
                    cartItemEl.className = 'flex items-center justify-between p-4 mb-2 bg-gray-50 rounded-lg shadow-sm';
                    cartItemEl.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <img src="${item.imageUrl}" alt="${item.name}" class="w-16 h-16 rounded-md object-cover">
                            <div>
                                <h4 class="font-semibold text-gray-800">${item.name}</h4>
                                <p class="text-sm text-gray-600">$${item.price.toFixed(2)} x ${item.quantity}</p>
                            </div>
                        </div>
                        <button data-product-id="${productId}" class="remove-from-cart-btn text-red-500 hover:text-red-700 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.215 21H7.785a2 2 0 01-1.918-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    `;
                    cartItemsContainer.appendChild(cartItemEl);
                });

                document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const productId = e.currentTarget.dataset.productId;
                        removeFromCart(productId);
                    });
                });
            }

            cartItemCountSpan.textContent = totalItems;
            cartTotalSpan.textContent = `$${total.toFixed(2)}`;
        }

        // Toggle cart panel visibility
        function toggleCart() {
            cartPanel.classList.toggle('translate-x-full');
            cartPanel.classList.toggle('hidden');
        }

        // Handle checkout process
        async function checkout() {
            if (Object.keys(cart).length === 0) {
                showModal('Cart is Empty', 'Please add some items to your cart before checking out.');
                return;
            }
            // For this mini-task, we'll just simulate a successful payment.
            showModal('Payment Successful!', 'Your order has been placed successfully. Thank you for your purchase!');
            
            // Clear the cart
            const userCartDocRef = doc(db, `artifacts/${appId}/users/${userId}/carts/cart`);
            try {
                await setDoc(userCartDocRef, { items: {} });
            } catch (error) {
                console.error("Error clearing cart: ", error);
            }
            toggleCart();
        }

        // Add event listeners
        cartBtn.addEventListener('click', toggleCart);
        closeCartBtn.addEventListener('click', toggleCart);
        checkoutBtn.addEventListener('click', checkout);

        // Run the app
        initializeAppAndAuth();
    </script>
</body>
</html>
